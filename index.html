<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#F3EBDD" />
  <title>Casa</title>

  <style>
    :root{
      /* Beige / neutral palette */
      --bg: #F6F0E6;
      --panel: #FFF9F0;
      --panel2: #F3EBDD;
      --border: rgba(35, 24, 16, .10);
      --text: #231810;
      --muted: rgba(35, 24, 16, .62);
      --muted2: rgba(35, 24, 16, .46);

      /* Accent: warm ink / espresso */
      --ink: #1E140D;
      --accent: #2A1B12;     /* deep brown */
      --accent2: #3A261A;    /* slightly lighter */
      --shadow: 0 18px 45px rgba(35, 24, 16, .10);
      --radius: 18px;
      --focus: 0 0 0 4px rgba(58,38,26,.18);

      /* Lobster star colors */
      --lobsterOn: #2A1B12;
      --lobsterOff: rgba(42,27,18,.18);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(58,38,26,.08), transparent 55%),
        radial-gradient(900px 650px at 92% 8%, rgba(42,27,18,.06), transparent 60%),
        var(--bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: 1040px; margin: 0 auto; padding: 0 16px; }

    /* Top bar */
    .nav{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(246,240,230,.78);
      border-bottom: 1px solid rgba(35,24,16,.08);
      padding-top: env(safe-area-inset-top);
    }
    .nav .wrap{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .brandName{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .brandName .top{
      font-size: 16px;
      font-weight: 1000;
      letter-spacing: .2px;
    }
    .brandName .sub{
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
    }

    .logoMark{
      width:40px; height:40px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,249,240,.9), rgba(243,235,221,.9));
      border: 1px solid rgba(35,24,16,.10);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 12px 30px rgba(35,24,16,.10);
      flex: 0 0 auto;
    }

    /* Buttons / controls */
    .btn{
      border:1px solid rgba(35,24,16,.14);
      background: rgba(255,249,240,.9);
      color: var(--ink);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ box-shadow: 0 10px 22px rgba(35,24,16,.08); }
    .btn:focus{ outline:none; box-shadow: var(--focus); }
    .btn.primary{
      border: 1px solid rgba(35,24,16,.18);
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#FFF9F0;
    }
    .btn.ghost{
      background: transparent;
      border:1px solid rgba(35,24,16,.12);
      color: var(--ink);
    }
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(35,24,16,.12);
      background: rgba(255,249,240,.85);
      font-weight: 900;
      font-size: 12px;
      color: var(--ink);
      max-width: 44vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .navRight{ display:flex; align-items:center; gap:10px; }

    /* Dropdown menu */
    .menuWrap{ position:relative; }
    .menu{
      position:absolute;
      right:0;
      top: calc(100% + 10px);
      width: 260px;
      background: rgba(255,249,240,.98);
      border: 1px solid rgba(35,24,16,.12);
      border-radius: 16px;
      box-shadow: 0 26px 70px rgba(35,24,16,.18);
      padding: 10px;
      display:none;
      z-index:999;
    }
    .menu.open{ display:block; }
    .menu .item{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 900;
      color: var(--ink);
      border: 1px solid transparent;
    }
    .menu .item:hover{
      background: rgba(243,235,221,.75);
      border-color: rgba(35,24,16,.08);
    }
    .menu .mutedItem{
      padding: 8px 10px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      line-height:1.3;
    }
    .menu .hr{
      height:1px;
      background: rgba(35,24,16,.10);
      margin: 8px 0;
    }

    /* Layout */
    .hero{
      padding: 26px 0 12px;
    }
    h1{
      margin: 0 0 10px;
      font-size: 42px;
      line-height: 1.04;
      letter-spacing: -1px;
    }
    .hero p{
      margin: 0 0 16px;
      color: var(--muted);
      max-width: 80ch;
      font-weight: 700;
    }

    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .search{
      flex: 1 1 520px;
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(255,249,240,.92);
      border:1px solid rgba(35,24,16,.12);
      border-radius: 999px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(35,24,16,.06);
    }
    .search input{
      border:none;
      outline:none;
      width:100%;
      font-size: 15px;
      color: var(--ink);
      background: transparent;
    }

    .select{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid rgba(35,24,16,.12);
      background: rgba(255,249,240,.92);
      font-weight: 900;
      color: var(--ink);
      box-shadow: 0 10px 30px rgba(35,24,16,.06);
    }
    .select select{
      border:none;
      outline:none;
      background: transparent;
      font-weight: 900;
      color: var(--ink);
      cursor:pointer;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 16px;
      margin: 14px 0 40px;
    }

    .card{
      background: rgba(255,249,240,.92);
      border:1px solid rgba(35,24,16,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding: 16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .bd{ padding: 10px 16px 16px; }

    .tiny{ font-size: 12.5px; color: var(--muted2); font-weight: 800; }
    .muted{ color: var(--muted); }

    /* Result row */
    .rowCard{
      display:flex;
      gap:12px;
      align-items:stretch;
      padding: 14px;
      border:1px solid rgba(35,24,16,.10);
      border-radius: 16px;
      background: rgba(255,249,240,.96);
      box-shadow: 0 10px 22px rgba(35,24,16,.06);
      cursor:pointer;
      margin-top: 12px;
      transition: transform .08s ease;
    }
    .rowCard:hover{ transform: translateY(-1px); }
    .rowMain{ flex:1; min-width:0; }
    .rowTitle{
      font-size: 16px;
      font-weight: 1000;
      margin: 0 0 6px;
      color: var(--ink);
      line-height:1.2;
    }
    .rowSub{
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .lobsterRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom: 6px;
    }
    .lobsterStars{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .lobster{
      width: 18px;
      height: 18px;
      display:block;
    }
    .scoreText{
      font-weight: 1000;
      font-size: 13px;
      color: var(--ink);
    }

    .tagRow{ display:flex; flex-wrap:wrap; gap:8px; }
    .tag{
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      border:1px solid rgba(35,24,16,.10);
      background: rgba(243,235,221,.65);
      color: rgba(35,24,16,.82);
    }

    /* Sidebar */
    .side{ padding: 16px; }
    .box{
      border:1px dashed rgba(35,24,16,.18);
      background: rgba(243,235,221,.55);
      padding: 12px;
      border-radius: 14px;
    }
    ul{ margin: 12px 0 0 18px; padding:0; }
    li{ margin: 8px 0; color: rgba(35,24,16,.78); font-weight: 800; }

    /* Profile */
    #profileView{ display:none; padding: 12px 0 40px; }
    .profileTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      width:100%;
    }
    h2{
      margin:0 0 6px;
      font-size: 28px;
      letter-spacing: -.5px;
      color: var(--ink);
    }
    .profileActions{ display:flex; gap:10px; flex-wrap:wrap; }
    .statsRow{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      align-items:start;
    }
    .bigScore{
      border:1px solid rgba(35,24,16,.12);
      border-radius: 18px;
      background: rgba(255,249,240,.96);
      padding: 14px;
      box-shadow: 0 10px 22px rgba(35,24,16,.06);
    }
    .bigScore .num{
      font-size: 40px;
      font-weight: 1000;
      line-height:1;
      color: var(--ink);
    }
    .bigScore .sub{
      margin-top:8px;
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
    }
    .barGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .bar{
      border:1px solid rgba(35,24,16,.12);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,249,240,.96);
      box-shadow: 0 10px 22px rgba(35,24,16,.06);
    }
    .barTop{
      display:flex; justify-content:space-between; align-items:center;
      font-weight: 1000;
      font-size: 13px;
      color: rgba(35,24,16,.82);
      margin-bottom: 8px;
    }
    .track{
      height: 10px;
      border-radius: 999px;
      background: rgba(35,24,16,.08);
      overflow:hidden;
      border:1px solid rgba(35,24,16,.08);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 999px;
    }

    /* Owner response */
    .ownerResp{
      margin-top:12px;
      padding:12px;
      border:1px solid rgba(35,24,16,.12);
      background: rgba(243,235,221,.55);
      border-radius: 14px;
    }
    .ownerRespTitle{
      font-weight: 1000;
      font-size: 12px;
      color: rgba(35,24,16,.85);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .6px;
    }
    .ownerRespDate{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      font-weight: 800;
    }

    /* Portal */
    .portalCard{
      margin-top:14px;
      padding: 14px;
      border-radius: 16px;
      border:1px solid rgba(35,24,16,.12);
      background: rgba(243,235,221,.55);
    }

    /* Modal */
    #modalBackdrop{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(35, 24, 16, .45);
      z-index: 999;
      padding: 18px;
      padding-top: calc(18px + env(safe-area-inset-top));
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }
    .modal{
      max-width: 620px;
      margin: 0 auto;
      background: rgba(255,249,240,.98);
      border-radius: 20px;
      overflow:hidden;
      border:1px solid rgba(35,24,16,.12);
      box-shadow: 0 30px 80px rgba(0,0,0,.20);
    }
    .modalHd{
      padding: 14px 16px;
      border-bottom:1px solid rgba(35,24,16,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .modalBd{ padding: 14px 16px; }
    .modalFt{
      padding: 12px 16px;
      border-top:1px solid rgba(35,24,16,.10);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    .field label{ font-size: 13px; font-weight: 1000; color: rgba(35,24,16,.82); }
    .field input, .field textarea, .field select{
      margin-top:6px;
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(35,24,16,.12);
      outline:none;
      font-size: 14px;
      background: rgba(255,249,240,.95);
      color: var(--ink);
    }
    .field input:focus, .field textarea:focus, .field select:focus{ box-shadow: var(--focus); border-color: rgba(35,24,16,.20); }
    textarea{ resize: vertical; min-height: 90px; }

    /* Mobile */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      h1{ font-size: 34px; }
      .statsRow{ grid-template-columns: 1fr; }
      .barGrid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 520px){
      .nav .wrap{ height:60px; }
      .pill{ display:none; } /* reduce clutter on small phones */
      .btn{ padding: 10px 12px; }
      .menu{ width: 92vw; max-width: 340px; }
      .rowCard{ padding: 12px; }
      .search{ padding: 11px 12px; }
    }
  </style>
</head>

<body>
  <div class="nav">
    <div class="wrap">
      <a class="brand" href="#" onclick="goHome(); return false;">
        <div class="logoMark" aria-hidden="true">
          <!-- Chevron/lines-inspired mark -->
          <svg width="26" height="22" viewBox="0 0 26 22" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M2 6 L13 12 L24 6" stroke="#1E140D" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round" opacity=".9"/>
            <path d="M2 10 L13 16 L24 10" stroke="#1E140D" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round" opacity=".8"/>
            <path d="M2 14 L13 20 L24 14" stroke="#1E140D" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round" opacity=".65"/>
          </svg>
        </div>
        <div class="brandName">
          <div class="top">Casa</div>
          <div class="sub">landlord reviews</div>
        </div>
      </a>

      <div class="navRight">
        <span id="userPill" class="pill" style="display:none;"></span>

        <div class="menuWrap">
          <button class="btn" id="menuBtn" onclick="toggleMenu()">☰ Menu</button>
          <div class="menu" id="menu">
            <div class="mutedItem" id="modeNote">Checking backend…</div>
            <div class="hr"></div>

            <div class="item" onclick="openModal('addLandlord')">
              <span>Add landlord</span><span>＋</span>
            </div>
            <div class="item" onclick="openModal('addReview')">
              <span>Write review</span><span>✎</span>
            </div>
            <div class="item" onclick="syncNow()">
              <span>Sync</span><span>↻</span>
            </div>

            <div class="hr"></div>

            <div class="item" id="authItem" onclick="openModal('auth')">
              <span>Log in</span><span>→</span>
            </div>
            <div class="item" id="logoutItem" style="display:none;" onclick="logout()">
              <span>Log out</span><span>⎋</span>
            </div>

            <div class="hr"></div>

            <div class="item" onclick="exportData()">
              <span>Export data</span><span>⤓</span>
            </div>
            <div class="item" onclick="openModal('importData')">
              <span>Import data</span><span>⤒</span>
            </div>
            <div class="item" onclick="resetAllData()">
              <span>Reset local data</span><span>⚠︎</span>
            </div>
          </div>
        </div>

        <button class="btn primary" onclick="openModal('addReview')">Write</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HOME VIEW -->
    <section id="homeView">
      <div class="hero">
        <h1>Find a landlord.<br/>Leave a review.</h1>
        <p>
          Casa keeps reviews simple and factual. Landlords can respond once verified (local dev),
          and GitHub Pages runs in “demo mode” using local storage.
        </p>

        <div class="toolbar">
          <div class="search">
            <span class="tiny">⌕</span>
            <input id="searchInput" placeholder="Search by landlord / neighborhood / city…" oninput="renderHome()" />
          </div>

          <div class="select" title="Sort">
            <span class="tiny">Sort</span>
            <select id="sortSelect" onchange="onSortChange()">
              <option value="overall_desc">Overall (high → low)</option>
              <option value="overall_asc">Overall (low → high)</option>
              <option value="repairs_desc">Repairs (high → low)</option>
              <option value="responsiveness_desc">Responsiveness (high → low)</option>
              <option value="deposits_desc">Deposits (high → low)</option>
              <option value="conditions_desc">Conditions (high → low)</option>
              <option value="communication_desc">Communication (high → low)</option>
              <option value="reviews_desc">Most reviews</option>
              <option value="new_desc">Newest landlord added</option>
            </select>
          </div>

          <button class="btn ghost" onclick="exportData()">Export</button>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="card">
            <div class="hd">
              <div>
                <div style="font-weight:1000;">Results</div>
                <div class="tiny">Tap a landlord to view details.</div>
              </div>
              <div class="tiny" id="resultCount"></div>
            </div>
            <div class="bd" id="landlordList"></div>
          </div>
        </div>

        <aside class="card side">
          <div style="font-weight:1000;">Posting guidelines</div>
          <div class="box" style="margin-top:10px;">
            <div class="tiny">
              Keep it factual. Avoid personal info. No threats/harassment.
            </div>
          </div>
          <ul>
            <li>Use dates (“work order 5/3, fixed 5/20”).</li>
            <li>No phone numbers/emails/SSNs.</li>
            <li>No threats, harassment, or discriminatory content.</li>
            <li>Keep addresses general (street + neighborhood is safest).</li>
          </ul>
          <div style="margin-top:12px;">
            <button class="btn primary" style="width:100%; justify-content:center;" onclick="openModal('addLandlord')">Add a landlord</button>
          </div>
          <div style="margin-top:10px;">
            <button class="btn" style="width:100%; justify-content:center;" onclick="openModal('importData')">Import JSON</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- PROFILE VIEW -->
    <section id="profileView">
      <div class="card">
        <div class="hd">
          <div class="profileTop">
            <div>
              <h2 id="profileName">—</h2>
              <div class="muted" id="profileSub">—</div>
            </div>
            <div class="profileActions">
              <button class="btn" onclick="goHome()">← Back</button>
              <button class="btn primary" onclick="openModal('addReview')">Write review</button>
              <button class="btn" onclick="openModal('claimLandlord')">Claim</button>
            </div>
          </div>
        </div>

        <div class="bd">
          <div class="statsRow">
            <div class="bigScore">
              <div class="lobsterRow">
                <div class="lobsterStars" id="profileLobsters"></div>
                <div class="scoreText"><span id="profileOverall">—</span></div>
              </div>
              <div class="sub"><span id="profileReviewCount">0</span> reviews • Overall</div>

              <div id="portalArea" class="portalCard" style="display:none;"></div>
            </div>

            <div class="barGrid" id="profileBars"></div>
          </div>

          <div style="margin-top:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
              <div style="font-weight:1000;">Reviews</div>
              <div class="tiny muted" id="profileReviewHint"></div>
            </div>
            <div id="profileReviews" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- MODAL -->
  <div id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHd">
        <div style="font-weight:1000;" id="modalTitle">—</div>
        <button class="btn" onclick="closeModal()">✕</button>
      </div>
      <div class="modalBd" id="modalBody"></div>
      <div class="modalFt">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" id="modalSubmitBtn" onclick="handleModalSubmit()">Save</button>
      </div>
    </div>
  </div>

<script>
  /***********************
   * Casa (single-file)
   * - Uses backend if reachable (local dev)
   * - Falls back to localStorage on GitHub Pages
   ***********************/

  // If you're running locally, keep these as-is:
  const API_BASE = "http://localhost:8787";
  const API_DB = `${API_BASE}/db`;

  // LocalStorage key for GitHub Pages demo mode
  const LS_KEY = "casa_db_v1";

  // In-memory data
  let db = { version: 1, landlords: [], reports: [] };

  // Backend mode flags
  let backendOnline = false;

  // Auth state (only meaningful when backendOnline)
  let currentUser = null;
  let myClaims = [];

  // UI state
  const state = {
    view: "home",
    selectedLandlordId: null,
    sortKey: "overall",
    sortDir: "desc",
    sortMode: "overall_desc"
  };

  // Modal state
  let currentModal = { type: null };

  /* ========= SVG helpers ========= */
  function lobsterSVG(on=true){
    const stroke = on ? "var(--lobsterOn)" : "var(--lobsterOff)";
    return `
      <svg class="lobster" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M22 20c-6-8-14-6-14 0 0 4 3 8 8 9" stroke="${stroke}" stroke-width="4" stroke-linecap="round"/>
        <path d="M42 20c6-8 14-6 14 0 0 4-3 8-8 9" stroke="${stroke}" stroke-width="4" stroke-linecap="round"/>
        <path d="M25 30c-5-4-10-4-14 0" stroke="${stroke}" stroke-width="4" stroke-linecap="round"/>
        <path d="M39 30c5-4 10-4 14 0" stroke="${stroke}" stroke-width="4" stroke-linecap="round"/>
        <path d="M32 18c-8 0-14 7-14 16 0 6 3 11 8 14v8c0 3 3 6 6 6s6-3 6-6v-8c5-3 8-8 8-14 0-9-6-16-14-16Z" stroke="${stroke}" stroke-width="4" stroke-linejoin="round"/>
        <path d="M26 40h12" stroke="${stroke}" stroke-width="4" stroke-linecap="round"/>
        <path d="M26 48h12" stroke="${stroke}" stroke-width="4" stroke-linecap="round" opacity=".9"/>
      </svg>
    `;
  }
  function renderLobsterStars(score){
    // score: 0..5 (may be null)
    if(score === null || score === undefined) return `<span class="tiny muted">No reviews</span>`;
    const filled = Math.round(score); // simple + clean
    let out = "";
    for(let i=1;i<=5;i++){
      out += lobsterSVG(i <= filled);
    }
    return out;
  }

  /* ========= Basic utils ========= */
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function avg(nums){
    if(!nums.length) return null;
    return nums.reduce((a,b)=>a+b,0) / nums.length;
  }
  function fmtScore(x){
    if(x === null || x === undefined) return "—";
    return (Math.round(x*10)/10).toFixed(1);
  }
  function matchesQuery(l, q){
    if(!q) return true;
    q = q.toLowerCase();
    const hay = [l.name, l.neighborhood, l.city].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  }
  function landlordStats(l){
    const rs = l.reviews || [];
    const keys = ["overall","repairs","responsiveness","deposits","conditions","communication"];
    const out = { count: rs.length };
    for(const k of keys){
      out[k] = avg(rs.map(r => (r.ratings && r.ratings[k]) ? Number(r.ratings[k]) : null).filter(v => v !== null));
    }
    return out;
  }
  function tagsFromStats(stats){
    const tags = [];
    if(!stats.count) return ["No reviews yet"];
    if(stats.repairs >= 4.2) tags.push("Fast repairs");
    if(stats.responsiveness >= 4.2) tags.push("Responsive");
    if(stats.communication >= 4.0) tags.push("Clear communication");
    if(stats.conditions <= 2.8) tags.push("Condition issues");
    if(stats.deposits <= 2.5) tags.push("Deposit issues");
    if(!tags.length) tags.push("Mixed experiences");
    return tags.slice(0,3);
  }

  function uuid(){
    if(crypto?.randomUUID) return crypto.randomUUID();
    return "id-" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  /* ========= Storage layer ========= */
  function readLocalDB(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { version: 1, landlords: [], reports: [] };
      const parsed = JSON.parse(raw);
      parsed.version = parsed.version || 1;
      parsed.landlords = parsed.landlords || [];
      parsed.reports = parsed.reports || [];
      return parsed;
    }catch{
      return { version: 1, landlords: [], reports: [] };
    }
  }
  function writeLocalDB(obj){
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
  }

  async function probeBackend(){
    // We mark backendOnline true if /db responds with JSON
    try{
      const r = await fetch(API_DB, { credentials:"include", cache:"no-store" });
      if(!r.ok) return false;
      await r.json();
      return true;
    }catch{
      return false;
    }
  }

  async function loadDB(){
    if(backendOnline){
      const res = await fetch(API_DB, { credentials:"include", cache:"no-store" });
      if(!res.ok) throw new Error("Backend not reachable");
      db = await res.json();
      db.version = db.version || 1;
      db.landlords = db.landlords || [];
      db.reports = db.reports || [];
      return;
    }
    db = readLocalDB();
  }

  async function saveDB(){
    if(backendOnline){
      await fetch(API_DB, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(db)
      });
      return;
    }
    writeLocalDB(db);
  }

  async function loadMe(){
    currentUser = null;
    if(!backendOnline) return;
    try{
      const r = await fetch(`${API_BASE}/auth/me`, { credentials:"include", cache:"no-store" });
      const data = await r.json().catch(()=> ({}));
      currentUser = data.user || null;
    }catch{
      currentUser = null;
    }
  }

  async function loadMyClaims(){
    myClaims = [];
    if(!backendOnline) return;
    if(!currentUser) return;
    try{
      const r = await fetch(`${API_BASE}/claims/mine`, { credentials:"include", cache:"no-store" });
      const data = await r.json().catch(()=> ({}));
      if(r.ok && Array.isArray(data.claims)) myClaims = data.claims;
    }catch{
      myClaims = [];
    }
  }

  /* ========= Menu / Auth pill ========= */
  function toggleMenu(){
    const m = document.getElementById("menu");
    m.classList.toggle("open");
  }
  function closeMenu(){
    document.getElementById("menu").classList.remove("open");
  }

  function renderAuthPill(){
    const pill = document.getElementById("userPill");
    const authItem = document.getElementById("authItem");
    const logoutItem = document.getElementById("logoutItem");
    const modeNote = document.getElementById("modeNote");

    if(!backendOnline){
      pill.style.display = "inline-flex";
      pill.textContent = "Demo mode (GitHub Pages)";
      authItem.style.display = "none";
      logoutItem.style.display = "none";
      modeNote.textContent = "Backend is offline here. Using local storage.";
      return;
    }

    modeNote.textContent = "Backend online (local dev).";
    authItem.style.display = "flex";

    if(!currentUser){
      pill.style.display = "none";
      logoutItem.style.display = "none";
      return;
    }

    pill.style.display = "inline-flex";
    pill.textContent = `${currentUser.email} • ${currentUser.role}`;
    logoutItem.style.display = "flex";
  }

  function myClaimForLandlord(landlordId){
    if(!currentUser) return null;
    return myClaims.find(c => String(c.landlord_id) === String(landlordId)) || null;
  }

  /* ========= Home rendering ========= */
  function onSortChange(){
    const v = document.getElementById("sortSelect").value;
    state.sortMode = v;

    // Map to key/dir
    const [key, dir] = v.split("_").slice(0,2);
    if(key === "reviews"){
      state.sortKey = "count";
      state.sortDir = "desc";
    }else if(key === "new"){
      state.sortKey = "created_at";
      state.sortDir = "desc";
    }else{
      state.sortKey = key;
      state.sortDir = (dir === "asc") ? "asc" : "desc";
    }
    renderHome();
  }

  function renderHome(){
    const q = (document.getElementById("searchInput").value || "").trim();
    const list = document.getElementById("landlordList");
    const resultCount = document.getElementById("resultCount");

    const landlords = (db.landlords || [])
      .filter(l => matchesQuery(l, q))
      .map(l => ({ l, stats: landlordStats(l) }));

    landlords.sort((a,b) => {
      const mode = state.sortMode;

      if(mode === "reviews_desc"){
        return (b.stats.count || 0) - (a.stats.count || 0);
      }
      if(mode === "new_desc"){
        const ta = Date.parse(a.l.created_at || a.l.createdAt || 0) || 0;
        const tb = Date.parse(b.l.created_at || b.l.createdAt || 0) || 0;
        return tb - ta;
      }

      const key = state.sortKey;
      const ka = (key === "count") ? a.stats.count : a.stats[key];
      const kb = (key === "count") ? b.stats.count : b.stats[key];

      if(ka === null && kb === null) return 0;
      if(ka === null) return 1;
      if(kb === null) return -1;
      return state.sortDir === "desc" ? (kb - ka) : (ka - kb);
    });

    resultCount.textContent = `${landlords.length} shown`;
    list.innerHTML = "";

    landlords.forEach(({l, stats}) => {
      const card = document.createElement("div");
      card.className = "rowCard";
      card.onclick = () => openProfile(l.id);

      const location = [l.neighborhood, l.city].filter(Boolean).join(" • ") || "—";
      const tags = tagsFromStats(stats);

      card.innerHTML = `
        <div class="rowMain">
          <div class="rowTitle">${escapeHtml(l.name || "—")}</div>
          <div class="lobsterRow">
            <div class="lobsterStars">${renderLobsterStars(stats.overall)}</div>
            <div class="scoreText">${fmtScore(stats.overall)}</div>
          </div>
          <div class="rowSub">${escapeHtml(location)} • ${stats.count} review${stats.count===1?"":"s"}</div>
          <div class="tagRow">
            ${tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
          </div>
        </div>
      `;
      list.appendChild(card);
    });
  }

  /* ========= Profile rendering ========= */
  function openProfile(id){
    state.view = "profile";
    state.selectedLandlordId = id;

    document.getElementById("homeView").style.display = "none";
    document.getElementById("profileView").style.display = "block";

    const l = db.landlords.find(x => x.id === id);
    if(!l){ alert("Landlord not found."); return; }

    const stats = landlordStats(l);

    document.getElementById("profileName").textContent = l.name || "—";
    document.getElementById("profileSub").textContent = [l.neighborhood, l.city].filter(Boolean).join(" • ") || "—";
    document.getElementById("profileOverall").textContent = fmtScore(stats.overall);
    document.getElementById("profileReviewCount").textContent = stats.count;

    document.getElementById("profileLobsters").innerHTML = renderLobsterStars(stats.overall);

    const barKeys = [
      ["repairs","Repairs"],
      ["responsiveness","Responsiveness"],
      ["deposits","Deposits"],
      ["conditions","Conditions"],
      ["communication","Communication"]
    ];
    document.getElementById("profileBars").innerHTML = barKeys.map(([k,label]) => {
      const v = stats[k];
      const pct = (v === null) ? 0 : Math.max(0, Math.min(100, (v/5)*100));
      return `
        <div class="bar">
          <div class="barTop"><span>${label}</span><span>${fmtScore(v)}</span></div>
          <div class="track"><div class="fill" style="width:${pct}%;"></div></div>
        </div>
      `;
    }).join("");

    renderPortalForLandlord(l);

    const reviewHint = document.getElementById("profileReviewHint");
    reviewHint.textContent = stats.count ? "" : "No reviews yet. Be the first.";

    const reviewBox = document.getElementById("profileReviews");
    reviewBox.innerHTML = "";

    const reviews = (l.reviews || []).slice().reverse();
    reviews.forEach(r => {
      const d = document.createElement("div");
      d.className = "rowCard";

      const createdRaw = r.createdAt || r.created_at || "";
      const created = createdRaw ? new Date(createdRaw).toLocaleDateString() : "";

      const resp = r.response || null;
      const respCreated = resp?.createdAt || resp?.created_at || "";
      const respHtml = resp
        ? `
          <div class="ownerResp">
            <div class="ownerRespTitle">Landlord response</div>
            <div style="white-space:pre-wrap; font-weight:800; color:rgba(35,24,16,.82);">
              ${escapeHtml(resp.text || "")}
            </div>
            <div class="ownerRespDate">
              ${respCreated ? new Date(respCreated).toLocaleString() : ""}
            </div>
          </div>
        `
        : "";

      d.innerHTML = `
        <div class="rowMain">
          <div class="rowTitle">${escapeHtml(r.title || "Review")}</div>
          <div class="lobsterRow" style="margin-top:-2px;">
            <div class="lobsterStars">${renderLobsterStars(r.ratings?.overall ?? null)}</div>
            <div class="scoreText">${fmtScore(r.ratings?.overall ?? null)}</div>
            <div class="tiny muted" style="margin-left:auto;">${escapeHtml(created)}</div>
          </div>
          <div style="font-weight:800; color:rgba(35,24,16,.78); white-space:pre-wrap; margin-top:6px;">
            ${escapeHtml(r.text || "")}
          </div>
          ${respHtml}
        </div>
      `;
      reviewBox.appendChild(d);
    });
  }

  function renderPortalForLandlord(l){
    const portal = document.getElementById("portalArea");
    portal.style.display = "block";
    portal.innerHTML = "";

    if(!backendOnline){
      portal.innerHTML = `
        <div style="font-weight:1000;">Owner portal</div>
        <div class="tiny muted" style="margin-top:6px;">
          On GitHub Pages, the backend isn’t running — so claim/verification and landlord responses are disabled here.
          Use your local backend to test those features.
        </div>
      `;
      return;
    }

    if(!currentUser){
      portal.innerHTML = `
        <div style="font-weight:1000;">Owner portal</div>
        <div class="tiny muted" style="margin-top:6px;">Log in to claim this listing and respond to reviews.</div>
      `;
      return;
    }

    const claim = myClaimForLandlord(l.id);
    let status = claim ? claim.status : "not claimed";

    const canRespond = (claim && claim.status === "approved") || (currentUser.role === "admin");

    portal.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
        <div>
          <div style="font-weight:1000;">Owner portal</div>
          <div class="tiny muted" style="margin-top:4px;">Claim status: <b>${escapeHtml(status)}</b></div>
        </div>
        <button class="btn" onclick="openModal('claimLandlord')">Claim</button>
      </div>

      <div style="margin-top:10px;">
        ${canRespond
          ? `<button class="btn primary" onclick="openModal('respondReview')">Respond to a review</button>`
          : `<div class="tiny muted">You must be approved before you can respond.</div>`
        }
      </div>
    `;
  }

  function goHome(){
    state.view = "home";
    state.selectedLandlordId = null;
    document.getElementById("profileView").style.display = "none";
    document.getElementById("homeView").style.display = "block";
    renderHome();
  }

  /* ========= Modals ========= */
  function openModal(type){
    closeMenu();
    currentModal.type = type;

    const title = document.getElementById("modalTitle");
    const body = document.getElementById("modalBody");
    const submitBtn = document.getElementById("modalSubmitBtn");
    submitBtn.style.display = "inline-flex";

    if(type === "auth"){
      title.textContent = "Log in / Sign up";
      if(!backendOnline){
        body.innerHTML = `<div class="tiny muted">Login requires the backend. On GitHub Pages this runs in demo mode.</div>`;
        submitBtn.style.display = "none";
      }else{
        body.innerHTML = `
          <div class="field">
            <label>Email</label>
            <input id="m_auth_email" placeholder="you@email.com" />
          </div>
          <div class="field" style="margin-top:10px;">
            <label>Password</label>
            <input id="m_auth_pw" type="password" placeholder="••••••••" />
          </div>
          <div class="field" style="margin-top:10px;">
            <label>I am a…</label>
            <select id="m_auth_role">
              <option value="tenant">Tenant</option>
              <option value="landlord">Landlord</option>
            </select>
          </div>
          <div class="tiny muted" style="margin-top:10px;">
            If login fails, we auto-create your account (signup). First ever user becomes admin.
          </div>
        `;
      }
    }

    if(type === "addLandlord"){
      title.textContent = "Add a landlord";
      body.innerHTML = `
        <div class="field">
          <label>Landlord / company name</label>
          <input id="m_landlord_name" placeholder="e.g., Northside Property Management" />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Neighborhood (optional)</label>
          <input id="m_landlord_neighborhood" placeholder="e.g., Brooklyn" />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>City (optional)</label>
          <input id="m_landlord_city" placeholder="e.g., New York, NY" />
        </div>
      `;
    }

    if(type === "addReview"){
      title.textContent = "Write a review";
      if(!state.selectedLandlordId){
        body.innerHTML = `<div class="tiny muted">Open a landlord profile first, then write a review.</div>`;
        submitBtn.style.display = "none";
      }else{
        body.innerHTML = `
          <div class="field">
            <label>Title (optional)</label>
            <input id="m_review_title" placeholder="e.g., Great communication" />
          </div>
          <div class="field" style="margin-top:10px;">
            <label>Your review</label>
            <textarea id="m_review_text" rows="5" placeholder="Keep it factual…"></textarea>
          </div>
          <div class="field" style="margin-top:10px;">
            <label>Overall (1–5)</label>
            <select id="m_overall">${[1,2,3,4,5].map(v=>`<option>${v}</option>`).join("")}</select>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;">
            ${ratingField("Repairs","m_repairs")}
            ${ratingField("Responsiveness","m_responsiveness")}
            ${ratingField("Deposits","m_deposits")}
            ${ratingField("Conditions","m_conditions")}
            ${ratingField("Communication","m_communication")}
          </div>
        `;
      }
    }

    if(type === "importData"){
      title.textContent = "Import data";
      body.innerHTML = `
        <div class="field">
          <label>Paste JSON export</label>
          <textarea id="m_import_json" rows="10" placeholder='{"version":1,"landlords":[...]}'></textarea>
        </div>
        <div class="tiny muted" style="margin-top:8px;">
          This overwrites current data (local demo data or backend data).
        </div>
      `;
    }

    if(type === "claimLandlord"){
      title.textContent = "Request verification (claim listing)";
      if(!backendOnline){
        body.innerHTML = `<div class="tiny muted">Claiming requires the backend. This page is in demo mode.</div>`;
        submitBtn.style.display = "none";
      }else if(!currentUser){
        body.innerHTML = `<div class="tiny muted">Please log in first.</div>`;
        submitBtn.style.display = "none";
      }else if(!state.selectedLandlordId){
        body.innerHTML = `<div class="tiny muted">Open a landlord profile first.</div>`;
        submitBtn.style.display = "none";
      }else{
        const l = db.landlords.find(x => x.id === state.selectedLandlordId);
        const claim = myClaimForLandlord(state.selectedLandlordId);
        const statusLine = claim ? `<div class="tiny muted">Current claim status: <b>${escapeHtml(claim.status)}</b></div>` : "";

        body.innerHTML = `
          <div class="tiny muted">You’re requesting verification for:</div>
          <div style="font-weight:1000; margin-top:6px;">${escapeHtml(l?.name || "—")}</div>
          <div class="tiny muted" style="margin-top:10px;">${statusLine}</div>

          <div class="field" style="margin-top:12px;">
            <label>Proof (type it here)</label>
            <textarea id="m_claim_proof" placeholder="Examples:
• Link to management website showing your name
• Business email used for leasing
• Lease header info (no personal tenant info)
• Any context for the admin"></textarea>
          </div>
        `;
      }
    }

    if(type === "respondReview"){
      title.textContent = "Respond to a review";
      if(!backendOnline){
        body.innerHTML = `<div class="tiny muted">Responding requires the backend. This page is in demo mode.</div>`;
        submitBtn.style.display = "none";
      }else if(!currentUser){
        body.innerHTML = `<div class="tiny muted">Please log in first.</div>`;
        submitBtn.style.display = "none";
      }else if(!state.selectedLandlordId){
        body.innerHTML = `<div class="tiny muted">Open a landlord profile first.</div>`;
        submitBtn.style.display = "none";
      }else{
        const claim = myClaimForLandlord(state.selectedLandlordId);
        const canRespond = (claim && claim.status === "approved") || (currentUser.role === "admin");
        if(!canRespond){
          body.innerHTML = `<div class="tiny muted">You must be approved for this listing before you can respond.</div>`;
          submitBtn.style.display = "none";
        }else{
          const l = db.landlords.find(x => x.id === state.selectedLandlordId);
          const options = (l?.reviews || []).slice().reverse().map(r => {
            const label = (r.title || "Review") + " — " + (r.text || "").slice(0, 40);
            return `<option value="${escapeHtml(r.id)}">${escapeHtml(label)}</option>`;
          }).join("");

          body.innerHTML = `
            <div class="tiny muted">Choose which review you’re responding to:</div>
            <div class="field" style="margin-top:8px;">
              <label>Review</label>
              <select id="m_resp_reviewId">${options || `<option value="">No reviews yet</option>`}</select>
            </div>
            <div class="field" style="margin-top:10px;">
              <label>Your response</label>
              <textarea id="m_resp_text" placeholder="Keep it professional and factual."></textarea>
            </div>
          `;
          if(!options) submitBtn.style.display = "none";
        }
      }
    }

    document.getElementById("modalBackdrop").style.display = "block";
    setTimeout(()=>{
      const first = body.querySelector("input,select,textarea");
      if(first) first.focus();
    }, 30);
  }

  function ratingField(label, id, def=5){
    return `
      <div class="field">
        <label>${label} (1–5)</label>
        <select id="${id}">
          ${[1,2,3,4,5].map(v => `<option ${v===def ? "selected":""}>${v}</option>`).join("")}
        </select>
      </div>
    `;
  }

  function closeModal(){
    document.getElementById("modalBackdrop").style.display = "none";
    document.getElementById("modalSubmitBtn").style.display = "inline-flex";
    currentModal.type = null;
  }

  async function handleModalSubmit(){
    const t = currentModal.type;

    if(t === "auth"){
      const email = (document.getElementById("m_auth_email").value || "").trim();
      const password = (document.getElementById("m_auth_pw").value || "").trim();
      const role = document.getElementById("m_auth_role").value;

      if(!email || !password) return alert("Enter email + password.");

      let r = await fetch(`${API_BASE}/auth/login`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });

      if(!r.ok){
        r = await fetch(`${API_BASE}/auth/signup`, {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password, role })
        });
      }

      const data = await r.json().catch(()=> ({}));
      if(!r.ok) return alert(data.error || "Auth failed");

      currentUser = data.user || null;
      await loadMyClaims().catch(()=>{});
      renderAuthPill();
      closeModal();
      alert(`Logged in as ${currentUser.email} (${currentUser.role})`);
      if(state.view === "profile" && state.selectedLandlordId){
        openProfile(state.selectedLandlordId);
      }
      return;
    }

    if(t === "addLandlord"){
      const name = (document.getElementById("m_landlord_name").value || "").trim();
      const neighborhood = (document.getElementById("m_landlord_neighborhood").value || "").trim();
      const city = (document.getElementById("m_landlord_city").value || "").trim();
      if(name.length < 2) return alert("Please enter a landlord name.");

      db.landlords.unshift({
        id: uuid(),
        name,
        neighborhood: neighborhood || null,
        city: city || null,
        created_at: new Date().toISOString(),
        reviews: []
      });

      await saveDB();
      closeModal();
      renderHome();
      openProfile(db.landlords[0].id);
      return;
    }

    if(t === "addReview"){
      if(!state.selectedLandlordId) return;

      const l = db.landlords.find(x => x.id === state.selectedLandlordId);
      if(!l) return alert("Landlord not found.");

      const title = (document.getElementById("m_review_title").value || "").trim();
      const text = (document.getElementById("m_review_text").value || "").trim();
      if(text.length < 10) return alert("Please write a bit more detail (10+ chars).");

      const ratings = {
        overall: Number(document.getElementById("m_overall").value),
        repairs: Number(document.getElementById("m_repairs").value),
        responsiveness: Number(document.getElementById("m_responsiveness").value),
        deposits: Number(document.getElementById("m_deposits").value),
        conditions: Number(document.getElementById("m_conditions").value),
        communication: Number(document.getElementById("m_communication").value),
      };

      l.reviews = l.reviews || [];
      l.reviews.push({
        id: uuid(),
        title,
        text,
        ratings,
        createdAt: new Date().toISOString()
      });

      await saveDB();
      closeModal();
      await syncNow(); // ensures responses attached in backend mode
      openProfile(l.id);
      return;
    }

    if(t === "importData"){
      const raw = (document.getElementById("m_import_json").value || "").trim();
      if(!raw) return alert("Paste your JSON export.");
      try{
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.landlords)) throw new Error("Invalid format.");
        db = parsed;
        db.version = db.version || 1;
        db.landlords = db.landlords || [];
        db.reports = db.reports || [];
        await saveDB();
        closeModal();
        goHome();
        alert("Imported successfully.");
      }catch(e){
        alert("Import failed: " + e.message);
      }
      return;
    }

    if(t === "claimLandlord"){
      if(!backendOnline) return;
      if(!currentUser) return;
      if(!state.selectedLandlordId) return;

      const proofText = (document.getElementById("m_claim_proof").value || "").trim();

      const r = await fetch(`${API_BASE}/claims/request`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ landlordId: state.selectedLandlordId, proofText })
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) return alert(data.error || "Claim request failed");

      await loadMyClaims().catch(()=>{});
      closeModal();
      alert("Claim submitted! Waiting for admin approval.");
      openProfile(state.selectedLandlordId);
      return;
    }

    if(t === "respondReview"){
      if(!backendOnline) return;
      const reviewId = (document.getElementById("m_resp_reviewId").value || "").trim();
      const text = (document.getElementById("m_resp_text").value || "").trim();
      if(!reviewId) return alert("Pick a review.");
      if(text.length < 5) return alert("Write a little more.");

      const r = await fetch(`${API_BASE}/reviews/respond`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ landlordId: state.selectedLandlordId, reviewId, text })
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) return alert(data.error || "Response failed");

      closeModal();
      await syncNow();
      alert("Response posted.");
      return;
    }
  }

  async function logout(){
    if(backendOnline){
      await fetch(`${API_BASE}/auth/logout`, { method:"POST", credentials:"include" }).catch(()=>{});
    }
    currentUser = null;
    myClaims = [];
    renderAuthPill();
    alert("Logged out.");
    if(state.view === "profile" && state.selectedLandlordId){
      openProfile(state.selectedLandlordId);
    }
  }

  /* ========= Export / Reset ========= */
  function exportData(){
    const payload = JSON.stringify(db, null, 2);
    const blob = new Blob([payload], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "casa_export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function resetAllData(){
    if(!confirm("This will erase data for this app in your current mode. Continue?")) return;
    db = { version: 1, landlords: [], reports: [] };
    await saveDB();
    goHome();
  }

  /* ========= Sync ========= */
  async function syncNow(){
    // Detect backend each sync (useful if you open locally vs github pages)
    backendOnline = await probeBackend();

    await loadMe().catch(()=>{});
    await loadMyClaims().catch(()=>{});
    await loadDB().catch(()=>{});

    renderAuthPill();

    if(state.view === "profile" && state.selectedLandlordId){
      openProfile(state.selectedLandlordId);
    }else{
      renderHome();
    }
  }

  /* ========= Global event wiring ========= */
  document.getElementById("modalBackdrop").addEventListener("click", (e)=>{
    if(e.target.id === "modalBackdrop") closeModal();
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") {
      closeModal();
      closeMenu();
    }
  });
  document.addEventListener("click", (e)=>{
    // close menu when clicking outside
    const menu = document.getElementById("menu");
    const btn = document.getElementById("menuBtn");
    if(menu.classList.contains("open")){
      if(!menu.contains(e.target) && !btn.contains(e.target)){
        closeMenu();
      }
    }
  });

  /* ========= Init ========= */
  (async function init(){
    try{
      // Ensure sort select matches default
      document.getElementById("sortSelect").value = "overall_desc";
      await syncNow();
    }catch(err){
      alert(err.message || "Failed to start.");
    }
  })();
</script>
</body>
</html>
