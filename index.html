<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- iPhone-friendly viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#6d28d9" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <title>RateMyLandlord</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel2:#f7f7fb;
      --border:#e7e7ef;
      --text:#0f172a;
      --muted:#667085;
      --muted2:#98a2b3;
      --accent:#6d28d9;
      --accent2:#7c3aed;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 18px 45px rgba(17, 24, 39, .10);
      --radius:18px;
      --focus: 0 0 0 4px rgba(124,58,237,.18);
    }
    *{ box-sizing:border-box; }
    html{ -webkit-text-size-adjust: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(124,58,237,.10), transparent 55%),
        radial-gradient(1000px 700px at 90% 10%, rgba(99,102,241,.12), transparent 60%),
        var(--bg);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: 1060px; margin: 0 auto; padding: 0 18px; }

    /* Top Nav */
    .nav{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(246,247,251,.78);
      border-bottom:1px solid rgba(231,231,239,.7);
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }
    .nav .wrap{
      height:68px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .logo{
      width:34px; height:34px;
      border-radius:12px;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      box-shadow: 0 10px 25px rgba(79,70,229,.25);
    }
    .nav-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      font-weight: 900;
      font-size: 12.5px;
      color:#111827;
      white-space:nowrap;
    }
    .pill.good{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.10); }
    .pill.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.12); }
    .pill.bad{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); }

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:#111827;
      padding:12px 16px;
      border-radius: 999px;
      font-weight:800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      min-height: 44px; /* iPhone tap target */
      touch-action: manipulation;
    }
    .btn:hover{ box-shadow: 0 10px 22px rgba(17,24,39,.08); }
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
    }
    .btn.danger{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color:#7f1d1d;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* Cards / Layout */
    .hero{ padding: 40px 0 16px; }
    h1{
      margin: 0 0 8px;
      font-size: 46px;
      line-height: 1.03;
      letter-spacing: -1px;
    }
    .hero p{
      margin: 0 0 18px;
      color: var(--muted);
      max-width: 80ch;
      font-weight: 600;
    }

    .searchRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .search{
      flex: 1 1 520px;
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(17,24,39,.06);
    }
    .search input{
      border:none;
      outline:none;
      width:100%;
      font-size: 16px; /* prevents iOS zoom */
      color:#111827;
      touch-action: manipulation;
    }
    .tiny{ font-size: 12.5px; color: var(--muted2); font-weight: 700; }
    .muted{ color: var(--muted); }

    .chipRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.85);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      color:#374151;
      cursor:pointer;
      touch-action: manipulation;
      min-height: 44px;
      display:inline-flex;
      align-items:center;
    }
    .chip.active{
      border-color: rgba(124,58,237,.35);
      background: rgba(124,58,237,.12);
      color: #4c1d95;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap: 18px;
      margin: 18px 0 40px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      h1{ font-size: 38px; }
    }

    .card{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .hd{
      padding: 18px 18px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .bd{ padding: 10px 18px 18px; }

    /* List items */
    .rowCard{
      display:flex;
      gap:14px;
      align-items:stretch;
      padding: 14px;
      border:1px solid var(--border);
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
      cursor:pointer;
      margin-top: 12px;
      touch-action: manipulation;
    }
    .rowCard:hover{ outline: 3px solid rgba(124,58,237,.12); }

    .scoreBox{
      width: 88px;
      min-width: 88px;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      gap:2px;
      border:1px solid rgba(22,163,74,.25);
      background: rgba(22,163,74,.10);
    }
    .scoreBox.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.12); }
    .scoreBox.bad{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); }
    .scoreNum{ font-size: 32px; line-height: 1; }
    .scoreText{ font-size: 12px; font-weight: 900; }

    .rowMain{ flex:1; }
    .rowTitle{ font-size: 18px; font-weight: 1000; margin: 2px 0 2px; }
    .rowSub{ color: var(--muted); font-weight: 800; font-size: 13px; margin-bottom: 10px; }
    .badgeRow{ display:flex; flex-wrap:wrap; gap:8px; }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      border:1px solid var(--border);
      background: #fff;
    }
    .badge.good{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.10); }
    .badge.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.12); }
    .badge.bad{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); }

    /* Sidebar */
    .side{ padding: 18px; }
    .box{
      border:1px dashed rgba(124,58,237,.35);
      background: rgba(124,58,237,.06);
      padding: 12px;
      border-radius: 14px;
    }
    ul{ margin: 12px 0 0 18px; padding:0; }
    li{ margin: 8px 0; color:#344054; font-weight: 700; }

    /* Profile view */
    #profileView{ display:none; padding: 18px 0 40px; }
    .profileTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      width:100%;
    }
    .profileActions{ display:flex; gap:10px; flex-wrap:wrap; }
    h2{ margin: 0 0 6px; font-size: 30px; letter-spacing: -.5px; }
    .statsRow{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .statsRow{ grid-template-columns: 1fr; }
    }
    .bigScore{
      border:1px solid var(--border);
      border-radius: 18px;
      background: #fff;
      padding: 16px;
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
    }
    .bigScore .num{
      font-size: 54px;
      font-weight: 1000;
      line-height: 1;
    }
    .bigScore .sub{
      margin-top:6px;
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
    }
    .barGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){ .barGrid{ grid-template-columns: 1fr; } }
    .bar{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
    }
    .barTop{
      display:flex; justify-content:space-between; align-items:center;
      font-weight: 1000;
      font-size: 13px;
      color:#344054;
      margin-bottom: 8px;
    }
    .track{
      height: 10px;
      border-radius: 999px;
      background: #eef2ff;
      overflow:hidden;
      border:1px solid rgba(79,70,229,.12);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 999px;
    }

    /* Owner response box */
    .ownerResp{
      margin-top:12px;
      padding:12px;
      border:1px solid rgba(124,58,237,.35);
      background: rgba(124,58,237,.06);
      border-radius: 14px;
    }
    .ownerRespTitle{
      font-weight: 1000;
      font-size: 12px;
      color: #5b3fd7;
      margin-bottom: 6px;
    }
    .ownerRespDate{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      font-weight: 800;
    }

    /* Portal card */
    .portalCard{
      margin-top:14px;
      padding: 14px;
      border-radius: 16px;
      border:1px solid rgba(124,58,237,.20);
      background: rgba(124,58,237,.05);
    }
    .portalTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .portalTitle{
      font-weight: 1000;
      font-size: 14px;
      color:#2e1065;
    }

    /* Modal */
    #modalBackdrop{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(15, 23, 42, .55);
      z-index: 999;
      padding: 22px;
    }
    .modal{
      max-width: 650px;
      margin: 0 auto;
      background:#fff;
      border-radius: 20px;
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
      width: 100%;
    }
    .modalHd{ padding: 16px 18px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .modalBd{ padding: 16px 18px; }
    .modalFt{ padding: 14px 18px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }

    .field label{ font-size: 13px; font-weight: 1000; color:#344054; }
    .field input, .field textarea, .field select{
      margin-top:6px;
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      outline:none;
      font-size: 16px; /* prevents iOS zoom */
      touch-action: manipulation;
    }
    .field input:focus, .field textarea:focus, .field select:focus{ box-shadow: var(--focus); border-color: rgba(124,58,237,.35); }
    textarea{ resize: vertical; min-height: 90px; }

    .hr{ height:1px; background: var(--border); margin: 12px 0; }

    /* Toast */
    .toastWrap{
      position: fixed;
      left: 0; right: 0;
      bottom: 12px;
      padding: 0 12px env(safe-area-inset-bottom);
      z-index: 1001;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      max-width: 720px;
      width: fit-content;
      background: rgba(17,24,39,.92);
      color: #fff;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 13px;
      display:flex;
      gap:10px;
      align-items:center;
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
    }
    .toast .tag{
      border-radius:999px;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 1000;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.12);
    }
    .toast button{
      border: none;
      background: rgba(255,255,255,.12);
      color:#fff;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
      min-height: 36px;
      touch-action: manipulation;
    }

    /* =========================
       iPhone / Mobile polish
       ========================= */
    button, a, input, select, textarea { touch-action: manipulation; }

    @media (max-width: 720px) {
      .wrap{ padding: 0 14px; }
      .nav .wrap{ height:auto; padding: 10px 14px; align-items:flex-start; }
      .nav-actions{ width:100%; gap: 8px; }
      .nav-actions .btn{ flex: 1 1 auto; justify-content:center; }
      h1{ font-size: 34px; }
      .hero{ padding: 26px 0 10px; }
      .searchRow{ flex-direction:column; align-items:stretch; }
      .searchRow .btn{ width:100%; justify-content:center; }
      .grid{ grid-template-columns: 1fr; }
      .statsRow{ grid-template-columns: 1fr; }
      .barGrid{ grid-template-columns: 1fr; }
      .rowCard{ padding: 12px; }
      .scoreBox{ width: 78px; min-width: 78px; }
    }

    /* Mobile modal becomes a bottom sheet */
    @media (max-width: 520px){
      #modalBackdrop{ padding: 0; display:none; align-items: flex-end; }
      #modalBackdrop[style*="display: block"]{ display:flex !important; }
      .modal{
        max-width: 100%;
        border-radius: 18px 18px 0 0;
        max-height: 92vh;
      }
      .modalBd{
        max-height: calc(92vh - 120px);
        overflow:auto;
        -webkit-overflow-scrolling: touch;
      }
    }
    @supports (height: 100dvh){
      #modalBackdrop{ min-height: 100dvh; }
    }
  </style>
</head>

<body>
  <div class="nav">
    <div class="wrap">
      <a class="brand" href="#" onclick="goHome(); return false;">
        <div class="logo"></div>
        <span>RateMyLandlord</span>
      </a>
      <div class="nav-actions">
        <span id="modePill" class="pill warn" style="display:none;"></span>
        <span id="userPill" class="pill" style="display:none;"></span>

        <button class="btn" id="authBtn" onclick="openModal('auth')">Log in</button>
        <button class="btn" id="logoutBtn" style="display:none;" onclick="logout()">Log out</button>

        <button class="btn" onclick="openModal('addLandlord')">Add Landlord</button>
        <button class="btn primary" onclick="openModal('addReview')">Write Review</button>
        <button class="btn" onclick="syncNow()">Sync</button>

        <button class="btn" id="adminBtn" style="display:none;" onclick="openModal('adminClaims')">Admin</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HOME VIEW -->
    <section id="homeView">
      <div class="hero">
        <h1>Look up a landlord. Add reviews. Share your experience.</h1>
        <p>
          This runs in two modes:
          <b>Local Dev</b> (full backend) and <b>GitHub Pages Demo</b> (stores data in your browser).
        </p>

        <div class="searchRow">
          <div class="search">
            <span class="tiny">üîé</span>
            <input id="searchInput" placeholder="Search by landlord / neighborhood / city..." oninput="renderHome()" />
          </div>
          <button class="btn" onclick="exportData()">Export</button>
          <button class="btn" onclick="openModal('importData')">Import</button>
        </div>

        <div class="chipRow">
          <div class="chip active" data-chip="overall" onclick="toggleSort('overall')">Sort: Overall</div>
          <div class="chip" data-chip="repairs" onclick="toggleSort('repairs')">Sort: Repairs</div>
          <div class="chip" data-chip="responsiveness" onclick="toggleSort('responsiveness')">Sort: Responsive</div>
          <div class="chip" data-chip="deposits" onclick="toggleSort('deposits')">Sort: Deposits</div>
          <div class="chip" data-chip="conditions" onclick="toggleSort('conditions')">Sort: Conditions</div>
          <div class="chip" data-chip="communication" onclick="toggleSort('communication')">Sort: Comms</div>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="card">
            <div class="hd">
              <div>
                <h3 style="margin:0;">Results</h3>
                <div class="tiny">Click a card to view details.</div>
              </div>
              <div class="tiny" id="resultCount"></div>
            </div>
            <div class="bd" id="landlordList"></div>
          </div>
        </div>

        <aside class="card side">
          <h3 style="margin-top:0;">Posting guidelines</h3>
          <div class="box">
            <div class="tiny">
              Keep it factual. Avoid personal info. No threats/harassment.
            </div>
          </div>
          <ul>
            <li>Use dates (‚Äúwork order 5/3, fixed 5/20‚Äù).</li>
            <li>No phone numbers/emails/SSNs.</li>
            <li>No threats, harassment, or discriminatory content.</li>
            <li>If you mention an address, keep it general (street + neighborhood is safest).</li>
          </ul>
          <div style="margin-top:12px;">
            <button class="btn primary" style="width:100%; justify-content:center;" onclick="openModal('addLandlord')">Add a landlord</button>
          </div>
          <div style="margin-top:10px;">
            <button class="btn" style="width:100%; justify-content:center;" onclick="resetAllData()">Reset all local data</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- PROFILE VIEW -->
    <section id="profileView">
      <div class="card">
        <div class="hd">
          <div class="profileTop">
            <div>
              <h2 id="profileName">‚Äî</h2>
              <div class="muted" id="profileSub">‚Äî</div>
            </div>
            <div class="profileActions">
              <button class="btn" onclick="goHome()">‚Üê Back</button>
              <button class="btn primary" onclick="openModal('addReview')">Write Review</button>
              <button class="btn" onclick="openModal('claimLandlord')">Claim</button>
            </div>
          </div>
        </div>

        <div class="bd">
          <div class="statsRow">
            <div class="bigScore">
              <div class="num" id="profileOverall">‚Äî</div>
              <div class="sub"><span id="profileReviewCount">0</span> reviews ‚Ä¢ Overall</div>
              <div style="margin-top:10px;" class="badgeRow" id="profileTags"></div>

              <div id="portalArea" class="portalCard" style="display:none;"></div>
            </div>

            <div class="barGrid" id="profileBars"></div>
          </div>

          <div style="margin-top:18px;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
              <h3 style="margin:0;">Reviews</h3>
              <div class="tiny muted" id="profileReviewHint"></div>
            </div>
            <div id="profileReviews" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- MODAL -->
  <div id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHd">
        <div style="font-weight:1000;" id="modalTitle">‚Äî</div>
        <button class="btn" onclick="closeModal()">‚úï</button>
      </div>
      <div class="modalBd" id="modalBody"></div>
      <div class="modalFt">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" id="modalSubmitBtn" onclick="handleModalSubmit()">Save</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toastWrap" id="toastWrap" style="display:none;">
    <div class="toast" id="toast">
      <span class="tag" id="toastTag">INFO</span>
      <span id="toastMsg">‚Äî</span>
      <button onclick="hideToast()">OK</button>
    </div>
  </div>

<script>
  /**********************
   * MODE DETECTION
   * - GitHub Pages cannot call localhost backend.
   * - So on github.io we run DEMO mode using LocalStorage.
   **********************/
  const IS_GH_PAGES = location.hostname.endsWith("github.io");
  const DEMO = IS_GH_PAGES;

  // Backend endpoints (used only when DEMO=false)
  const API_BASE = "http://localhost:8787";
  const API_DB   = `${API_BASE}/db`;

  // LocalStorage keys (used when DEMO=true)
  const LS_DB_KEY = "rml_db_v1";
  const LS_AUTH_KEY = "rml_user_v1";
  const LS_CLAIMS_KEY = "rml_claims_v1";
  const LS_RESP_KEY = "rml_responses_v1"; // map key landlordId:reviewId => response

  // Data in memory
  let db = { version: 1, landlords: [], reports: [] };
  let currentUser = null;
  let myClaims = []; // [{id, landlord_id, user_id/email, status, proof_text, created_at}]

  // UI state
  const state = {
    view: "home",
    selectedLandlordId: null,
    sortKey: "overall",
    sortDir: "desc"
  };

  // Modal state
  let currentModal = { type: null };

  /**********************
   * TOAST (no blocking alerts)
   **********************/
  function showToast(msg, tag="INFO"){
    const wrap = document.getElementById("toastWrap");
    const ttag = document.getElementById("toastTag");
    const tmsg = document.getElementById("toastMsg");
    ttag.textContent = tag;
    tmsg.textContent = msg;
    wrap.style.display = "flex";
  }
  function hideToast(){
    document.getElementById("toastWrap").style.display = "none";
  }

  /**********************
   * DEMO STORAGE HELPERS
   **********************/
  function lsGet(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch{
      return fallback;
    }
  }
  function lsSet(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  function demoEnsure(){
    // DB
    const existing = lsGet(LS_DB_KEY, null);
    if(!existing){
      lsSet(LS_DB_KEY, { version: 1, landlords: [], reports: [] });
    }
    // Claims
    const c = lsGet(LS_CLAIMS_KEY, null);
    if(!c) lsSet(LS_CLAIMS_KEY, []);
    // Responses
    const r = lsGet(LS_RESP_KEY, null);
    if(!r) lsSet(LS_RESP_KEY, {});
  }

  /**********************
   * BACKEND I/O (LOCAL DEV)
   **********************/
  async function loadDB_backend(){
    const res = await fetch(API_DB, { credentials: "include" });
    if(!res.ok) throw new Error("Backend not reachable.");
    db = await res.json();
    db.version = db.version || 1;
    db.landlords = db.landlords || [];
    db.reports = db.reports || [];
  }
  async function saveDB_backend(){
    const res = await fetch(API_DB, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(db)
    });
    if(!res.ok) throw new Error("Save failed.");
  }
  async function loadMe_backend(){
    const r = await fetch(`${API_BASE}/auth/me`, { credentials: "include" });
    const data = await r.json().catch(()=> ({}));
    currentUser = data.user || null;
  }
  async function loadMyClaims_backend(){
    myClaims = [];
    if(!currentUser) return;
    const r = await fetch(`${API_BASE}/claims/mine`, { credentials: "include" });
    const data = await r.json().catch(()=> ({}));
    if(r.ok && Array.isArray(data.claims)) myClaims = data.claims;
  }

  /**********************
   * DEMO I/O (GITHUB PAGES)
   **********************/
  async function loadDB_demo(){
    demoEnsure();
    db = lsGet(LS_DB_KEY, { version: 1, landlords: [], reports: [] });
    // Attach responses into db reviews (same shape as backend)
    const respMap = lsGet(LS_RESP_KEY, {});
    for(const l of (db.landlords || [])){
      l.reviews = l.reviews || [];
      for(const rv of l.reviews){
        const key = `${l.id}:${rv.id}`;
        if(respMap[key]) rv.response = respMap[key];
      }
    }
  }
  async function saveDB_demo(){
    // strip attached response objects before saving (we store responses separately)
    const clean = structuredClone(db);
    for(const l of (clean.landlords || [])){
      l.reviews = l.reviews || [];
      for(const rv of l.reviews){
        if(rv.response) delete rv.response;
      }
    }
    lsSet(LS_DB_KEY, clean);
  }
  async function loadMe_demo(){
    currentUser = lsGet(LS_AUTH_KEY, null);
  }
  async function loadMyClaims_demo(){
    myClaims = [];
    if(!currentUser) return;
    const all = lsGet(LS_CLAIMS_KEY, []);
    myClaims = all.filter(c => c.user_id === currentUser.id);
  }

  /**********************
   * UNIFIED I/O
   **********************/
  async function loadAll(){
    if(DEMO){
      await loadMe_demo();
      await loadMyClaims_demo();
      await loadDB_demo();
    }else{
      await loadMe_backend();
      await loadMyClaims_backend();
      await loadDB_backend();
    }
  }
  async function saveDB(){
    if(DEMO) return saveDB_demo();
    return saveDB_backend();
  }

  async function syncNow(){
    try{
      await loadAll();
      renderModePill();
      renderAuthPill();
      renderAdminBtn();
      if(state.view === "profile" && state.selectedLandlordId){
        openProfile(state.selectedLandlordId);
      }else{
        renderHome();
      }
      if(DEMO){
        // no ‚Äúfail to fetch‚Äù popups on GH pages
      }
    }catch(err){
      showToast(err.message || "Sync failed.", "ERROR");
    }
  }

  /**********************
   * UI PILL RENDERING
   **********************/
  function renderModePill(){
    const pill = document.getElementById("modePill");
    if(!DEMO){
      pill.style.display = "none";
      return;
    }
    pill.style.display = "inline-flex";
    pill.className = "pill warn";
    pill.textContent = "Demo Mode (GitHub Pages)";
  }

  function renderAuthPill(){
    const pill = document.getElementById("userPill");
    const authBtn = document.getElementById("authBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    if(!currentUser){
      pill.style.display = "none";
      authBtn.style.display = "inline-flex";
      logoutBtn.style.display = "none";
      return;
    }

    pill.style.display = "inline-flex";
    pill.textContent = `${currentUser.email} ‚Ä¢ ${currentUser.role}`;
    authBtn.style.display = "none";
    logoutBtn.style.display = "inline-flex";
  }

  function renderAdminBtn(){
    const btn = document.getElementById("adminBtn");
    if(currentUser && currentUser.role === "admin"){
      btn.style.display = "inline-flex";
    }else{
      btn.style.display = "none";
    }
  }

  /**********************
   * HELPERS
   **********************/
  function avg(nums){
    if(!nums.length) return null;
    return nums.reduce((a,b)=>a+b,0) / nums.length;
  }
  function fmtScore(x){
    if(x === null || x === undefined) return "‚Äî";
    return (Math.round(x*10)/10).toFixed(1);
  }
  function landlordStats(l){
    const rs = l.reviews || [];
    const keys = ["overall","repairs","responsiveness","deposits","conditions","communication"];
    const out = { count: rs.length };
    for(const k of keys){
      out[k] = avg(rs.map(r => (r.ratings && r.ratings[k]) ? Number(r.ratings[k]) : null).filter(v => v !== null));
    }
    return out;
  }
  function scoreLabel(score){
    if(score === null) return { text:"No Reviews", cls:"warn" };
    if(score >= 4.0) return { text:"Excellent", cls:"good" };
    if(score >= 3.0) return { text:"Okay", cls:"warn" };
    return { text:"Avoid", cls:"bad" };
  }
  function tagsFromStats(stats){
    const tags = [];
    if(!stats.count) return [{ t:"No Reviews Yet", cls:"warn" }];
    if(stats.repairs >= 4.2) tags.push({ t:"Fast Repairs", cls:"good" });
    if(stats.responsiveness >= 4.2) tags.push({ t:"Very Responsive", cls:"good" });
    if(stats.deposits <= 2.5) tags.push({ t:"Deposit Issues", cls:"bad" });
    if(stats.conditions <= 2.8) tags.push({ t:"Poor Conditions", cls:"bad" });
    if(stats.communication >= 4.0) tags.push({ t:"Good Communication", cls:"good" });
    if(!tags.length) tags.push({ t:"Mixed Reviews", cls:"warn" });
    return tags.slice(0, 3);
  }
  function matchesQuery(l, q){
    if(!q) return true;
    q = q.toLowerCase();
    const hay = [l.name, l.neighborhood, l.city].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function myClaimForLandlord(landlordId){
    if(!currentUser) return null;
    return myClaims.find(c => String(c.landlord_id) === String(landlordId)) || null;
  }

  /**********************
   * HOME RENDER
   **********************/
  function renderHome(){
    const q = (document.getElementById("searchInput").value || "").trim();
    const list = document.getElementById("landlordList");
    const resultCount = document.getElementById("resultCount");

    const landlords = (db.landlords || [])
      .filter(l => matchesQuery(l, q))
      .map(l => ({ l, stats: landlordStats(l) }));

    landlords.sort((a,b) => {
      const ka = a.stats[state.sortKey];
      const kb = b.stats[state.sortKey];
      if(ka === null && kb === null) return 0;
      if(ka === null) return 1;
      if(kb === null) return -1;
      return state.sortDir === "desc" ? (kb - ka) : (ka - kb);
    });

    resultCount.textContent = `${landlords.length} shown`;
    list.innerHTML = "";

    landlords.forEach(({l, stats}) => {
      const score = stats.overall;
      const lbl = scoreLabel(score);
      const tags = tagsFromStats(stats);
      const reviewCount = stats.count;

      const card = document.createElement("div");
      card.className = "rowCard";
      card.onclick = () => openProfile(l.id);

      card.innerHTML = `
        <div class="scoreBox ${lbl.cls}">
          <div class="scoreNum">${fmtScore(score)}</div>
          <div class="scoreText">${lbl.text}</div>
        </div>
        <div class="rowMain">
          <div class="rowTitle">${escapeHtml(l.name)}</div>
          <div class="rowSub">
            ${escapeHtml([l.neighborhood, l.city].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî")}
            ‚Ä¢ ${reviewCount} review${reviewCount===1?"":"s"}
          </div>
          <div class="badgeRow">
            ${tags.map(t => `<span class="badge ${t.cls}">${escapeHtml(t.t)}</span>`).join("")}
          </div>
        </div>
      `;
      list.appendChild(card);
    });
  }

  function toggleSort(key){
    if(state.sortKey === key){
      state.sortDir = state.sortDir === "desc" ? "asc" : "desc";
    }else{
      state.sortKey = key;
      state.sortDir = "desc";
    }
    document.querySelectorAll(".chipRow .chip").forEach(el=>{
      el.classList.toggle("active", el.dataset.chip === state.sortKey);
    });
    renderHome();
  }

  /**********************
   * PROFILE VIEW
   **********************/
  function openProfile(id){
    state.view = "profile";
    state.selectedLandlordId = id;

    document.getElementById("homeView").style.display = "none";
    document.getElementById("profileView").style.display = "block";

    const l = db.landlords.find(x => x.id === id);
    if(!l){ showToast("Landlord not found.", "ERROR"); return; }
    const stats = landlordStats(l);

    document.getElementById("profileName").textContent = l.name || "‚Äî";
    document.getElementById("profileSub").textContent = [l.neighborhood, l.city].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî";
    document.getElementById("profileOverall").textContent = fmtScore(stats.overall);
    document.getElementById("profileReviewCount").textContent = stats.count;

    const tags = tagsFromStats(stats);
    document.getElementById("profileTags").innerHTML = tags.map(t => `<span class="badge ${t.cls}">${escapeHtml(t.t)}</span>`).join("");

    const barKeys = [
      ["repairs","Repairs"],
      ["responsiveness","Responsiveness"],
      ["deposits","Deposits"],
      ["conditions","Conditions"],
      ["communication","Communication"]
    ];
    document.getElementById("profileBars").innerHTML = barKeys.map(([k,label]) => {
      const v = stats[k];
      const pct = (v === null) ? 0 : Math.max(0, Math.min(100, (v/5)*100));
      return `
        <div class="bar">
          <div class="barTop"><span>${label}</span><span>${fmtScore(v)}</span></div>
          <div class="track"><div class="fill" style="width:${pct}%;"></div></div>
        </div>
      `;
    }).join("");

    renderPortalForLandlord(l);

    const reviewHint = document.getElementById("profileReviewHint");
    reviewHint.textContent = stats.count ? "" : "No reviews yet. Be the first.";

    const reviewBox = document.getElementById("profileReviews");
    reviewBox.innerHTML = "";

    const reviews = (l.reviews || []).slice().reverse();
    reviews.forEach(r => {
      const d = document.createElement("div");
      d.className = "rowCard";

      const createdRaw = r.createdAt || r.created_at || "";
      const created = createdRaw ? new Date(createdRaw).toLocaleDateString() : "";

      const resp = r.response || null;
      const respCreated = resp?.createdAt || resp?.created_at || "";
      const respHtml = resp
        ? `
          <div class="ownerResp">
            <div class="ownerRespTitle">Landlord response</div>
            <div style="white-space:pre-wrap; font-weight:750; color:#344054;">
              ${escapeHtml(resp.text || "")}
            </div>
            <div class="ownerRespDate">
              ${respCreated ? new Date(respCreated).toLocaleString() : ""}
            </div>
          </div>
        `
        : "";

      d.innerHTML = `
        <div class="scoreBox ${scoreLabel(r.ratings?.overall ?? null).cls}">
          <div class="scoreNum">${fmtScore(r.ratings?.overall ?? null)}</div>
          <div class="scoreText">Overall</div>
        </div>
        <div class="rowMain">
          <div class="rowTitle">${escapeHtml(r.title || "Review")}</div>
          <div class="rowSub">${created}</div>
          <div style="font-weight:750; color:#344054; white-space:pre-wrap;">
            ${escapeHtml(r.text || "")}
          </div>
          ${respHtml}
        </div>
      `;
      reviewBox.appendChild(d);
    });
  }

  function renderPortalForLandlord(l){
    const portal = document.getElementById("portalArea");
    portal.style.display = "none";
    portal.innerHTML = "";

    if(!currentUser) return;

    const claim = myClaimForLandlord(l.id);
    let statusPill = "";
    if(claim){
      const cls = claim.status === "approved" ? "good" : (claim.status === "denied" ? "bad" : "warn");
      statusPill = `<span class="pill ${cls}">Claim: ${escapeHtml(claim.status)}</span>`;
    }else{
      statusPill = `<span class="pill warn">Not claimed</span>`;
    }

    portal.style.display = "block";
    const canRespond = (claim && claim.status === "approved") || (currentUser.role === "admin");

    portal.innerHTML = `
      <div class="portalTop">
        <div>
          <div class="portalTitle">Landlord portal</div>
          <div class="tiny muted">To respond, you must be verified for this listing.</div>
        </div>
        <div>${statusPill}</div>
      </div>

      <div class="hr"></div>

      <div>
        <div class="tiny muted" style="margin-bottom:6px;">
          Claim this listing (submit proof for admin review):
        </div>
        <button class="btn" onclick="openModal('claimLandlord')">Request verification</button>
      </div>

      <div class="hr"></div>

      <div>
        <div class="tiny muted" style="margin-bottom:6px;">
          Respond to a review (approved owners only):
        </div>
        ${canRespond ? `
          <button class="btn primary" onclick="openModal('respondReview')">Write a response</button>
        ` : `
          <span class="tiny muted">You must be approved before you can respond.</span>
        `}
      </div>
    `;
  }

  function goHome(){
    state.view = "home";
    state.selectedLandlordId = null;
    document.getElementById("profileView").style.display = "none";
    document.getElementById("homeView").style.display = "block";
    renderHome();
  }

  /**********************
   * MODALS
   **********************/
  function openModal(type){
    currentModal.type = type;
    const title = document.getElementById("modalTitle");
    const body = document.getElementById("modalBody");
    const submitBtn = document.getElementById("modalSubmitBtn");
    submitBtn.style.display = "inline-flex";
    submitBtn.disabled = false;

    if(type === "auth"){
      title.textContent = "Log in / Sign up";
      body.innerHTML = `
        <div class="field">
          <label>Email</label>
          <input id="m_auth_email" placeholder="you@email.com" autocapitalize="none" autocomplete="email" />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Password</label>
          <input id="m_auth_pw" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>I am a...</label>
          <select id="m_auth_role">
            <option value="tenant">Tenant</option>
            <option value="landlord">Landlord</option>
          </select>
        </div>
        <div class="tiny muted" style="margin-top:10px;">
          ${DEMO
            ? "Demo Mode: account is stored on this device only."
            : "Local Dev: first-ever user becomes admin on the backend."}
        </div>
      `;
    }

    if(type === "addLandlord"){
      title.textContent = "Add a landlord";
      body.innerHTML = `
        <div class="field">
          <label>Landlord / company name</label>
          <input id="m_landlord_name" placeholder="e.g., Northside Property Management" />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Neighborhood (optional)</label>
          <input id="m_landlord_neighborhood" placeholder="e.g., Brooklyn" />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>City (optional)</label>
          <input id="m_landlord_city" placeholder="e.g., New York, NY" />
        </div>
      `;
    }

    if(type === "addReview"){
      title.textContent = "Write a review";
      if(!state.selectedLandlordId){
        body.innerHTML = `<div class="tiny muted">First, click a landlord from Results. Then hit ‚ÄúWrite Review.‚Äù</div>`;
        submitBtn.style.display = "none";
      }else{
        body.innerHTML = `
          <div class="field">
            <label>Title (optional)</label>
            <input id="m_review_title" placeholder="e.g., Great communication" />
          </div>
          <div class="field" style="margin-top:10px;">
            <label>Your review</label>
            <textarea id="m_review_text" rows="5" placeholder="Keep it factual..."></textarea>
          </div>
          <div class="field" style="margin-top:10px;">
            <label>Overall (1‚Äì5)</label>
            <select id="m_overall">${[1,2,3,4,5].map(v=>`<option>${v}</option>`).join("")}</select>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;">
            ${ratingField("Repairs","m_repairs")}
            ${ratingField("Responsiveness","m_responsiveness")}
            ${ratingField("Deposits","m_deposits")}
            ${ratingField("Conditions","m_conditions")}
            ${ratingField("Communication","m_communication")}
          </div>
        `;
      }
    }

    if(type === "importData"){
      title.textContent = "Import data";
      body.innerHTML = `
        <div class="field">
          <label>Paste JSON export</label>
          <textarea id="m_import_json" rows="10" placeholder='{"version":1,"landlords":[...]}'></textarea>
        </div>
        <div class="tiny muted" style="margin-top:8px;">
          This will overwrite your current data.
        </div>
      `;
    }

    if(type === "claimLandlord"){
      title.textContent = "Request verification (claim listing)";
      if(!currentUser){
        body.innerHTML = `<div class="tiny muted">Please log in first.</div>`;
        submitBtn.style.display = "none";
      }else if(!state.selectedLandlordId){
        body.innerHTML = `<div class="tiny muted">Open a landlord profile first.</div>`;
        submitBtn.style.display = "none";
      }else{
        const l = db.landlords.find(x => x.id === state.selectedLandlordId);
        const claim = myClaimForLandlord(state.selectedLandlordId);
        const statusLine = claim ? `<div class="tiny muted">Current claim status: <b>${escapeHtml(claim.status)}</b></div>` : "";

        body.innerHTML = `
          <div class="tiny muted">
            You‚Äôre requesting permission to respond as the verified owner/manager for:
          </div>
          <div style="font-weight:1000; margin-top:6px;">${escapeHtml(l?.name || "‚Äî")}</div>
          <div class="tiny muted" style="margin-top:10px;">${statusLine}</div>

          <div class="field" style="margin-top:12px;">
            <label>Proof (type it here)</label>
            <textarea id="m_claim_proof" placeholder="Examples:
‚Ä¢ Link to management site showing your name
‚Ä¢ Business email domain used for leasing
‚Ä¢ Lease header info (no personal tenant info)
‚Ä¢ Any context for the admin"></textarea>
          </div>

          <div class="tiny muted" style="margin-top:10px;">
            ${DEMO
              ? "Demo Mode: approvals happen inside this page via Admin (if you‚Äôre admin)."
              : "Local Dev: admin approves claims via Admin UI (or curl)."}
          </div>
        `;
      }
    }

    if(type === "respondReview"){
      title.textContent = "Respond to a review";
      if(!currentUser){
        body.innerHTML = `<div class="tiny muted">Please log in first.</div>`;
        submitBtn.style.display = "none";
      }else if(!state.selectedLandlordId){
        body.innerHTML = `<div class="tiny muted">Open a landlord profile first.</div>`;
        submitBtn.style.display = "none";
      }else{
        const claim = myClaimForLandlord(state.selectedLandlordId);
        const canRespond = (claim && claim.status === "approved") || (currentUser.role === "admin");
        if(!canRespond){
          body.innerHTML = `<div class="tiny muted">You must be approved for this listing before you can respond.</div>`;
          submitBtn.style.display = "none";
        }else{
          const l = db.landlords.find(x => x.id === state.selectedLandlordId);
          const options = (l?.reviews || []).slice().reverse().map(r => {
            const label = (r.title || "Review") + " ‚Äî " + (r.text || "").slice(0, 40);
            return `<option value="${escapeHtml(r.id)}">${escapeHtml(label)}</option>`;
          }).join("");

          body.innerHTML = `
            <div class="tiny muted">Choose which review you‚Äôre responding to:</div>
            <div class="field" style="margin-top:8px;">
              <label>Review</label>
              <select id="m_resp_reviewId">${options || `<option value="">No reviews yet</option>`}</select>
            </div>
            <div class="field" style="margin-top:10px;">
              <label>Your response</label>
              <textarea id="m_resp_text" placeholder="Keep it professional and factual."></textarea>
            </div>
          `;
          if(!options) submitBtn.style.display = "none";
        }
      }
    }

    if(type === "adminClaims"){
      title.textContent = "Admin: Pending claims";
      if(!currentUser || currentUser.role !== "admin"){
        body.innerHTML = `<div class="tiny muted">Admin only.</div>`;
        submitBtn.style.display = "none";
      }else{
        submitBtn.textContent = "Close";
        submitBtn.onclick = () => closeModal();

        // Render list
        const pending = getPendingClaims();
        body.innerHTML = `
          <div class="tiny muted" style="margin-bottom:10px;">
            Approve/deny landlord verification requests.
          </div>
          ${pending.length ? pending.map(c => `
            <div class="rowCard" style="cursor:default;">
              <div class="rowMain">
                <div class="rowTitle">${escapeHtml(c.landlord_name || c.landlord_id)}</div>
                <div class="rowSub">${escapeHtml(c.email || "‚Äî")} ‚Ä¢ ${new Date(c.created_at).toLocaleString()}</div>
                <div style="white-space:pre-wrap; font-weight:750; color:#344054;">
                  ${escapeHtml(c.proof_text || "")}
                </div>
                <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn primary" onclick="adminApprove('${escapeHtml(c.id)}')">Approve</button>
                  <button class="btn danger" onclick="adminDeny('${escapeHtml(c.id)}')">Deny</button>
                </div>
              </div>
            </div>
          `).join("") : `<div class="tiny muted">No pending claims.</div>`}
        `;
      }
    }

    // show modal
    const backdrop = document.getElementById("modalBackdrop");
    backdrop.style.display = "block";
    backdrop.style.pointerEvents = "auto";

    setTimeout(()=>{
      const first = document.getElementById("modalBody").querySelector("input,select,textarea");
      if(first) first.focus();
    }, 30);
  }

  function ratingField(label, id, def=5){
    return `
      <div class="field">
        <label>${label} (1‚Äì5)</label>
        <select id="${id}">
          ${[1,2,3,4,5].map(v => `<option ${v===def ? "selected":""}>${v}</option>`).join("")}
        </select>
      </div>
    `;
  }

  function closeModal(){
    const backdrop = document.getElementById("modalBackdrop");
    backdrop.style.display = "none";
    // Safety: if iOS gets weird, ensure hidden backdrop never blocks taps
    backdrop.style.pointerEvents = "none";
    setTimeout(() => { backdrop.style.pointerEvents = "auto"; }, 0);

    document.getElementById("modalSubmitBtn").style.display = "inline-flex";
    document.getElementById("modalSubmitBtn").disabled = false;
    document.getElementById("modalSubmitBtn").textContent = "Save";
    document.getElementById("modalSubmitBtn").onclick = () => handleModalSubmit();
    currentModal.type = null;
  }

  async function handleModalSubmit(){
    const t = currentModal.type;
    const submitBtn = document.getElementById("modalSubmitBtn");
    submitBtn.disabled = true;

    try{
      if(t === "auth"){
        const email = (document.getElementById("m_auth_email").value || "").trim().toLowerCase();
        const password = (document.getElementById("m_auth_pw").value || "").trim();
        const role = document.getElementById("m_auth_role").value;

        if(!email || !password) { submitBtn.disabled=false; return showToast("Enter email + password.", "WARN"); }

        if(DEMO){
          // Demo: create user locally; first user becomes admin
          const existing = lsGet(LS_AUTH_KEY, null);
          const isFirst = !existing && !lsGet("rml_any_user_exists", false);
          const finalRole = isFirst ? "admin" : (role === "landlord" ? "landlord" : "tenant");
          const user = { id: crypto.randomUUID(), email, role: finalRole };
          lsSet(LS_AUTH_KEY, user);
          lsSet("rml_any_user_exists", true);
          currentUser = user;
          await loadMyClaims_demo();
          renderAuthPill(); renderAdminBtn();
          closeModal();
          showToast(`Logged in: ${currentUser.role}`, "OK");
          if(state.view === "profile" && state.selectedLandlordId) openProfile(state.selectedLandlordId);
          return;
        }

        // Local dev: login first; if fails, signup
        let r = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        if(!r.ok){
          r = await fetch(`${API_BASE}/auth/signup`, {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, role })
          });
        }

        const data = await r.json().catch(()=> ({}));
        if(!r.ok) { submitBtn.disabled=false; return showToast(data.error || "Auth failed", "ERROR"); }

        currentUser = data.user || null;
        await loadMyClaims_backend().catch(()=>{});
        renderAuthPill(); renderAdminBtn();
        closeModal();
        showToast(`Logged in: ${currentUser.role}`, "OK");
        if(state.view === "profile" && state.selectedLandlordId) openProfile(state.selectedLandlordId);
        return;
      }

      if(t === "addLandlord"){
        const name = (document.getElementById("m_landlord_name").value || "").trim();
        const neighborhood = (document.getElementById("m_landlord_neighborhood").value || "").trim();
        const city = (document.getElementById("m_landlord_city").value || "").trim();
        if(name.length < 2){ submitBtn.disabled=false; return showToast("Please enter a landlord name.", "WARN"); }

        db.landlords.unshift({
          id: crypto.randomUUID(),
          name,
          neighborhood: neighborhood || null,
          city: city || null,
          created_at: new Date().toISOString(),
          reviews: []
        });

        await saveDB();
        closeModal();
        renderHome();
        openProfile(db.landlords[0].id);
        showToast("Landlord saved.", "OK");
        return;
      }

      if(t === "addReview"){
        if(!state.selectedLandlordId){ submitBtn.disabled=false; return; }
        const l = db.landlords.find(x => x.id === state.selectedLandlordId);
        if(!l){ submitBtn.disabled=false; return showToast("Landlord not found.", "ERROR"); }

        const title = (document.getElementById("m_review_title").value || "").trim();
        const text = (document.getElementById("m_review_text").value || "").trim();
        if(text.length < 10){ submitBtn.disabled=false; return showToast("Write a bit more detail (10+ chars).", "WARN"); }

        const ratings = {
          overall: Number(document.getElementById("m_overall").value),
          repairs: Number(document.getElementById("m_repairs").value),
          responsiveness: Number(document.getElementById("m_responsiveness").value),
          deposits: Number(document.getElementById("m_deposits").value),
          conditions: Number(document.getElementById("m_conditions").value),
          communication: Number(document.getElementById("m_communication").value),
        };

        l.reviews = l.reviews || [];
        l.reviews.push({
          id: crypto.randomUUID(),
          title,
          text,
          ratings,
          createdAt: new Date().toISOString()
        });

        await saveDB();
        closeModal();
        openProfile(l.id);
        showToast("Review posted.", "OK");
        return;
      }

      if(t === "importData"){
        const raw = (document.getElementById("m_import_json").value || "").trim();
        if(!raw){ submitBtn.disabled=false; return showToast("Paste your JSON export.", "WARN"); }
        try{
          const parsed = JSON.parse(raw);
          if(!parsed || !Array.isArray(parsed.landlords)) throw new Error("Invalid format.");
          db = parsed;
          db.version = db.version || 1;
          db.landlords = db.landlords || [];
          db.reports = db.reports || [];
          await saveDB();
          closeModal();
          goHome();
          showToast("Imported successfully.", "OK");
        }catch(e){
          submitBtn.disabled=false;
          showToast("Import failed: " + e.message, "ERROR");
        }
        return;
      }

      if(t === "claimLandlord"){
        if(!currentUser){ submitBtn.disabled=false; return showToast("Log in first.", "WARN"); }
        if(!state.selectedLandlordId){ submitBtn.disabled=false; return; }

        const proofText = (document.getElementById("m_claim_proof").value || "").trim();

        if(DEMO){
          const all = lsGet(LS_CLAIMS_KEY, []);
          const id = crypto.randomUUID();
          const l = db.landlords.find(x => x.id === state.selectedLandlordId);
          all.push({
            id,
            landlord_id: state.selectedLandlordId,
            landlord_name: l?.name || state.selectedLandlordId,
            user_id: currentUser.id,
            email: currentUser.email,
            status: "pending",
            proof_text: proofText.slice(0, 4000),
            created_at: new Date().toISOString()
          });
          lsSet(LS_CLAIMS_KEY, all);
          await loadMyClaims_demo();
          closeModal();
          showToast("Claim submitted (pending).", "OK");
          openProfile(state.selectedLandlordId);
          return;
        }

        const r = await fetch(`${API_BASE}/claims/request`, {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ landlordId: state.selectedLandlordId, proofText })
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok){ submitBtn.disabled=false; return showToast(data.error || "Claim request failed", "ERROR"); }

        await loadMyClaims_backend().catch(()=>{});
        closeModal();
        showToast("Claim submitted (pending).", "OK");
        openProfile(state.selectedLandlordId);
        return;
      }

      if(t === "respondReview"){
        const reviewId = (document.getElementById("m_resp_reviewId").value || "").trim();
        const text = (document.getElementById("m_resp_text").value || "").trim();
        if(!reviewId){ submitBtn.disabled=false; return showToast("Pick a review.", "WARN"); }
        if(text.length < 5){ submitBtn.disabled=false; return showToast("Write a little more.", "WARN"); }

        if(DEMO){
          const claim = myClaimForLandlord(state.selectedLandlordId);
          const canRespond = (claim && claim.status === "approved") || (currentUser.role === "admin");
          if(!canRespond){ submitBtn.disabled=false; return showToast("Not verified for this listing.", "ERROR"); }

          const respMap = lsGet(LS_RESP_KEY, {});
          respMap[`${state.selectedLandlordId}:${reviewId}`] = { text, createdAt: new Date().toISOString() };
          lsSet(LS_RESP_KEY, respMap);

          closeModal();
          await syncNow();
          showToast("Response posted.", "OK");
          return;
        }

        const r = await fetch(`${API_BASE}/reviews/respond`, {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ landlordId: state.selectedLandlordId, reviewId, text })
        });
        const data = await r.json().catch(()=> ({}));
        if(!r.ok){ submitBtn.disabled=false; return showToast(data.error || "Response failed", "ERROR"); }

        closeModal();
        await syncNow();
        showToast("Response posted.", "OK");
        return;
      }

      // Default: close
      closeModal();
    } finally {
      // Only re-enable if modal is still open
      const backdrop = document.getElementById("modalBackdrop");
      if(backdrop.style.display === "block"){
        submitBtn.disabled = false;
      }
    }
  }

  /**********************
   * ADMIN (demo + local)
   **********************/
  function getPendingClaims(){
    if(!currentUser || currentUser.role !== "admin") return [];
    if(DEMO){
      const all = lsGet(LS_CLAIMS_KEY, []);
      const pending = all.filter(c => c.status === "pending");
      return pending;
    }
    // Local backend: we fetch live
    // NOTE: for simplicity we do an on-demand fetch when opening modal
    return [];
  }

  async function adminApprove(id){
    if(!currentUser || currentUser.role !== "admin") return;
    if(DEMO){
      const all = lsGet(LS_CLAIMS_KEY, []);
      const c = all.find(x => x.id === id);
      if(c) c.status = "approved";
      lsSet(LS_CLAIMS_KEY, all);
      await loadMyClaims_demo();
      openModal("adminClaims"); // refresh view
      showToast("Approved.", "OK");
      return;
    }
    // Local backend: needs claimId numeric from backend list.
    // If you want this fully wired locally, tell me and I‚Äôll plug in /claims/pending fetch + approve/deny.
    showToast("Local admin UI needs backend /claims/pending wired. (Say: 'wire local admin ui')", "INFO");
  }

  async function adminDeny(id){
    if(!currentUser || currentUser.role !== "admin") return;
    if(DEMO){
      const all = lsGet(LS_CLAIMS_KEY, []);
      const c = all.find(x => x.id === id);
      if(c) c.status = "denied";
      lsSet(LS_CLAIMS_KEY, all);
      await loadMyClaims_demo();
      openModal("adminClaims");
      showToast("Denied.", "OK");
      return;
    }
    showToast("Local admin UI needs backend /claims/pending wired. (Say: 'wire local admin ui')", "INFO");
  }

  /**********************
   * LOGOUT
   **********************/
  async function logout(){
    try{
      if(DEMO){
        lsSet(LS_AUTH_KEY, null);
        currentUser = null;
        myClaims = [];
      }else{
        await fetch(`${API_BASE}/auth/logout`, { method:"POST", credentials:"include" }).catch(()=>{});
        currentUser = null;
        myClaims = [];
      }
      renderAuthPill(); renderAdminBtn();
      showToast("Logged out.", "OK");
      if(state.view === "profile" && state.selectedLandlordId) openProfile(state.selectedLandlordId);
    }catch{
      showToast("Logout failed.", "ERROR");
    }
  }

  /**********************
   * EXPORT / RESET
   **********************/
  function exportData(){
    const payload = JSON.stringify(db, null, 2);
    const blob = new Blob([payload], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ratemylandlord_export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function resetAllData(){
    const ok = confirm("This will erase all landlords/reviews in your local data for this browser. Continue?");
    if(!ok) return;
    db = { version: 1, landlords: [], reports: [] };
    if(DEMO){
      lsSet(LS_DB_KEY, db);
      lsSet(LS_CLAIMS_KEY, []);
      lsSet(LS_RESP_KEY, {});
    }else{
      await saveDB().catch(()=>{});
    }
    goHome();
    showToast("Reset complete.", "OK");
  }

  /**********************
   * MODAL CLOSE HELPERS
   **********************/
  document.getElementById("modalBackdrop").addEventListener("click", (e)=>{
    if(e.target.id === "modalBackdrop") closeModal();
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") closeModal();
  });

  /**********************
   * INIT
   **********************/
  (async function init(){
    renderModePill();
    // If on GitHub Pages, do NOT show scary ‚Äúfailed to fetch‚Äù popups
    if(DEMO){
      demoEnsure();
      await syncNow();
      showToast("Demo mode: data saves in this browser.", "INFO");
      return;
    }
    // Local dev
    await syncNow();
  })();
</script>
</body>
</html>
